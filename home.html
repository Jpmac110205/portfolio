<!DOCTYPE html>

<html>
    <h1>this is the home page</h1>


    <div style="width: 500px; background-color: aqua;">
        <div id='messages'>
            <p>line1</p>
            <p>line2</p>
            <p>line3</p>
        </div>
        <input id="messageToSend" type="text"/>
        <br>
        <button onclick="sendMessage()">send message</button>



    </div>



<script>
    let socket;

    async function sendMessage() {
        const input = document.getElementById("messageToSend");
        const msg = input.value.trim();
        if (!msg) return;

        if (!socket || socket.readyState === WebSocket.CLOSED) {
            socket = new WebSocket('ws://localhost:3000');

            socket.addEventListener('open', () => {
                console.log("connected");
            });

            socket.addEventListener('message', event => {
                console.log(event.data);

                const messageArea = document.getElementById("messages");

                let data;
                try {
                    console.log('workgin1');
                    data = JSON.parse(event.data);
                    console.log('workgin2');
                    messageArea.innerHTML += `<p>${data.author}: ${data.content}</p>`;
                } catch (ex) {
                    data = event.data;
                    messageArea.innerHTML += `<p>${data}</p>`;
                }

            });

            socket.addEventListener('error', err => {
                console.error('WebSocket error:', err);
            });

            socket.addEventListener('close', () => {
                console.log('ðŸ”´ Disconnected');
            });
        }

        if (socket.readyState === WebSocket.CONNECTING) {
            await new Promise(resolve => {
                socket.addEventListener("open", resolve, { once: true });
            });
            console.log("ðŸŸ¢ Connected");
        }

        // 3) Now that we're guaranteed OPEN, send your message:
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(msg);
            console.log("â†’", msg);
            input.value = "";
        } else {
            console.error("Socket isnâ€™t open (state=", socket.readyState, ")");
        }
    }


</script>


</html>